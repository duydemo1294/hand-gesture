<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CHIẾN DỊCH NEON - FPT POLYTECHNIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"
      crossorigin="anonymous"
    ></script>

    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
      }
      #video-container {
        position: absolute;
        width: 1px;
        height: 1px;
        opacity: 0;
      }
      canvas {
        display: block;
      }
      #ui-root {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 50;
        pointer-events: none;
      }
      .neon-text {
        text-shadow: 0 0 10px #0ff;
        color: #0ff;
      }
      .pointer-events-auto {
        pointer-events: auto;
      }
      .bg-grid {
        background-image: linear-gradient(to right, #111 1px, transparent 1px),
          linear-gradient(to bottom, #111 1px, transparent 1px);
        background-size: 60px 60px;
      }
    </style>
  </head>
  <body class="bg-grid">
    <video id="video-container" autoplay playsinline></video>
    <div id="ui-root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      function NeonApp() {
        const [isRunning, setIsRunning] = useState(false);
        const [isGameOver, setIsGameOver] = useState(false);
        const [score, setScore] = useState(0);
        const [timeLeft, setTimeLeft] = useState(15);
        const [handStatus, setHandStatus] = useState("ĐANG TÌM TAY...");

        const gameRef = useRef({
          scene: null,
          camera: null,
          renderer: null,
          targets: [],
          crosshair: null,
          handData: null,
          isFiring: false,
          isRunning: false,
        });

        useEffect(() => {
          const scene = new THREE.Scene();
          const camera = new THREE.PerspectiveCamera(
            75,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
          );
          camera.position.z = 5;

          const renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: true,
          });
          renderer.setSize(window.innerWidth, window.innerHeight);
          document.body.appendChild(renderer.domElement);

          const crossGeometry = new THREE.RingGeometry(0.1, 0.15, 32);
          const crossMaterial = new THREE.MeshBasicMaterial({
            color: 0x00ffff,
            side: THREE.DoubleSide,
          });
          const crosshair = new THREE.Mesh(crossGeometry, crossMaterial);
          crosshair.visible = false;
          scene.add(crosshair);

          gameRef.current = {
            ...gameRef.current,
            scene,
            camera,
            renderer,
            crosshair,
          };

          const animate = () => {
            const g = gameRef.current;
            if (g.isRunning) {
              g.targets.forEach((t) => {
                t.mesh.position.add(t.velocity);
                t.mesh.rotation.x += 0.02;
                t.mesh.rotation.y += 0.02;
                t.life--;
                if (
                  t.life <= 0 ||
                  Math.abs(t.mesh.position.x) > 10 ||
                  Math.abs(t.mesh.position.y) > 8
                ) {
                  resetTarget(t);
                }
              });

              if (g.handData) {
                g.crosshair.visible = true;
                const tx = (0.5 - g.handData[8].x) * 12;
                const ty = (0.5 - g.handData[8].y) * 8;
                g.crosshair.position.x += (tx - g.crosshair.position.x) * 0.2;
                g.crosshair.position.y += (ty - g.crosshair.position.y) * 0.2;

                const dist = Math.sqrt(
                  Math.pow(g.handData[4].x - g.handData[5].x, 2) +
                    Math.pow(g.handData[4].y - g.handData[5].y, 2)
                );

                if (dist < 0.08) {
                  if (!g.isFiring) {
                    checkHit();
                    g.isFiring = true;
                  }
                } else {
                  g.isFiring = false;
                }
              } else {
                g.crosshair.visible = false;
              }
            }
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
          };
          animate();
        }, []);

        const resetTarget = (target) => {
          const angle = Math.random() * Math.PI * 2;
          target.mesh.position.set(Math.cos(angle) * 5, Math.sin(angle) * 4, 0);
          target.velocity.set(
            (Math.random() - 0.5) * 0.06,
            (Math.random() - 0.5) * 0.06,
            0
          );
          target.life = 200 + Math.random() * 100;
        };

        const checkHit = () => {
          const g = gameRef.current;
          g.targets.forEach((t) => {
            const d = t.mesh.position.distanceTo(g.crosshair.position);
            if (d < 0.6) {
              setScore((prev) => prev + 100);
              resetTarget(t);
            }
          });
        };

        const startGame = async () => {
          const g = gameRef.current;
          g.targets.forEach((t) => g.scene.remove(t.mesh));
          g.targets = [];

          for (let i = 0; i < 6; i++) {
            const mesh = new THREE.Mesh(
              new THREE.IcosahedronGeometry(0.3, 0),
              new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true })
            );
            const target = { mesh, velocity: new THREE.Vector3(), life: 0 };
            resetTarget(target);
            g.scene.add(mesh);
            g.targets.push(target);
          }

          const hands = new Hands({
            locateFile: (file) =>
              `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`,
          });
          hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5,
          });
          hands.onResults((res) => {
            const found =
              res.multiHandLandmarks && res.multiHandLandmarks.length > 0;
            g.handData = found ? res.multiHandLandmarks[0] : null;
            setHandStatus(found ? "ĐÃ NHẬN TAY" : "ĐANG TÌM TAY...");
          });

          const video = document.getElementById("video-container");
          const cam = new Camera(video, {
            onFrame: async () => {
              await hands.send({ image: video });
            },
            width: 1280,
            height: 720,
          });

          await cam.start();
          g.isRunning = true;
          setIsRunning(true);
          setIsGameOver(false);
          setScore(0);
          setTimeLeft(15);
        };

        useEffect(() => {
          let timer;
          if (isRunning && timeLeft > 0) {
            timer = setInterval(() => setTimeLeft((p) => p - 1), 1000);
          } else if (timeLeft === 0 && isRunning) {
            gameRef.current.isRunning = false;
            setIsRunning(false);
            setIsGameOver(true);
            // Dọn dẹp mục tiêu khi hết giờ
            gameRef.current.targets.forEach((t) =>
              gameRef.current.scene.remove(t.mesh)
            );
          }
          return () => clearInterval(timer);
        }, [isRunning, timeLeft]);

        return (
          <div id="ui-root">
            <div className="absolute top-10 left-10 p-4 bg-black/80 border-l-4 border-cyan-400">
              <div className="text-xs text-cyan-400 font-bold tracking-widest uppercase">
                ĐIỂM
              </div>
              <div className="text-5xl font-black neon-text italic">
                {score}
              </div>
            </div>

            <div className="absolute top-10 right-10 p-4 bg-black/80 border-r-4 border-white text-right">
              <div className="text-xs text-white/40 font-bold uppercase tracking-widest">
                THỜI GIAN
              </div>
              <div
                className={`text-5xl font-black ${
                  timeLeft <= 5 ? "text-red-500 animate-pulse" : "text-white"
                }`}
              >
                {timeLeft}s
              </div>
            </div>

            {!isRunning && !isGameOver && (
              <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/90 pointer-events-auto">
                <h1 className="text-6xl font-black text-white mb-10 tracking-tighter uppercase">
                  Chiến Dịch <span className="neon-text italic">Neon</span>
                </h1>
                <button
                  onClick={startGame}
                  className="px-20 py-6 bg-cyan-400 text-black font-black uppercase tracking-[0.5em] shadow-[0_0_30px_#0ff] hover:scale-105 transition-transform"
                >
                  Bắt đầu
                </button>
              </div>
            )}

            {isGameOver && (
              <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/95 pointer-events-auto backdrop-blur-md">
                <div className="text-cyan-400 text-xs tracking-[1em] mb-4 font-bold uppercase">
                  Nhiệm vụ hoàn tất
                </div>
                <div className="text-[10rem] font-black text-white leading-none mb-10 drop-shadow-[0_0_30px_rgba(0,255,255,0.3)]">
                  {score}
                </div>
                <button
                  onClick={() => window.location.reload()}
                  className="px-12 py-4 border-2 border-cyan-400 text-cyan-400 font-bold uppercase tracking-widest hover:bg-cyan-400 hover:text-black transition-all"
                >
                  Chơi lại
                </button>
              </div>
            )}

            {isRunning && (
              <div className="absolute bottom-10 right-10 text-[10px] text-white/30 uppercase tracking-[0.2em] font-bold">
                Hệ thống AI:{" "}
                <span
                  className={
                    handStatus === "ĐÃ NHẬN TAY"
                      ? "text-green-500"
                      : "text-red-500"
                  }
                >
                  {handStatus}
                </span>
              </div>
            )}

            <div className="absolute bottom-6 left-1/2 -translate-x-1/2 text-[11px] tracking-[0.5em] text-white/20 uppercase font-bold pointer-events-auto">
              FPT Polytechnic Cần Thơ
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("ui-root"));
      root.render(<NeonApp />);
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </body>
</html>
