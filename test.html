<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CHIẾN DỊCH NEON - FPT POLYTECHNIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"
      crossorigin="anonymous"
    ></script>

    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
        font-family: "Inter", sans-serif;
      }
      #video-container {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 240px;
        height: 180px;
        border-radius: 12px;
        border: 2px solid rgba(0, 255, 255, 0.3);
        z-index: 100;
        transform: scaleX(-1);
        object-fit: cover;
        display: none;
      }
      button {
        font-family: system-ui !important;
      }
      .neon-text {
        text-shadow:
          0 0 10px #0ff,
          0 0 20px #0ff;
        color: #0ff;
      }
      .glass-panel {
        background: rgba(20, 20, 20, 0.8);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .bg-grid {
        background-image:
          linear-gradient(to right, #111 1px, transparent 1px),
          linear-gradient(to bottom, #111 1px, transparent 1px);
        background-size: 60px 60px;
      }
    </style>
  </head>
  <body class="bg-grid">
    <video id="video-container" autoplay playsinline></video>
    <div id="ui-root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // Khởi tạo các đối tượng Audio
      const soundShoot = new Audio("shoot.mp3");
      const soundHit = new Audio("hit.mp3");
      const soundDone = new Audio("done.mp3");

      function NeonApp() {
        const [isRunning, setIsRunning] = useState(false);
        const [isGameOver, setIsGameOver] = useState(false);
        const [score, setScore] = useState(0);
        const [timeLeft, setTimeLeft] = useState(30);
        const [gameDuration, setGameDuration] = useState(30); // State mới để lưu cấu hình thời gian
        const [handStatus, setHandStatus] = useState("ĐANG TÌM TAY...");

        const gameRef = useRef({
          scene: null,
          camera: null,
          renderer: null,
          targets: [],
          crosshair: null,
          handData: null,
          isFiring: false,
          isRunning: false,
        });

        useEffect(() => {
          const scene = new THREE.Scene();
          const camera = new THREE.PerspectiveCamera(
            75,
            window.innerWidth / window.innerHeight,
            0.1,
            1000,
          );
          camera.position.z = 5;

          const renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: true,
          });
          renderer.setSize(window.innerWidth, window.innerHeight);
          document.body.appendChild(renderer.domElement);

          const crosshair = new THREE.Mesh(
            new THREE.RingGeometry(0.1, 0.15, 32),
            new THREE.MeshBasicMaterial({
              color: 0x00ffff,
              side: THREE.DoubleSide,
            }),
          );
          crosshair.visible = false;
          scene.add(crosshair);

          gameRef.current = {
            ...gameRef.current,
            scene,
            camera,
            renderer,
            crosshair,
          };

          const animate = () => {
            const g = gameRef.current;
            if (g.isRunning) {
              g.targets.forEach((t) => {
                t.mesh.position.add(t.velocity);
                t.mesh.rotation.x += 0.02;
                if (t.life-- <= 0) resetTarget(t);
              });

              if (g.handData) {
                g.crosshair.visible = true;
                const tx = (0.5 - g.handData[8].x) * 12;
                const ty = (0.5 - g.handData[8].y) * 8;
                g.crosshair.position.x += (tx - g.crosshair.position.x) * 0.2;
                g.crosshair.position.y += (ty - g.crosshair.position.y) * 0.2;

                const dist = Math.sqrt(
                  Math.pow(g.handData[4].x - g.handData[8].x, 2) +
                    Math.pow(g.handData[4].y - g.handData[8].y, 2),
                );

                if (dist < 0.05) {
                  if (!g.isFiring) {
                    soundShoot.currentTime = 0;
                    soundShoot.play().catch(() => {});
                    checkHit();
                    g.isFiring = true;
                    g.crosshair.scale.set(0.7, 0.7, 1);
                  }
                } else {
                  g.isFiring = false;
                  g.crosshair.scale.set(1, 1, 1);
                }
              } else {
                g.crosshair.visible = false;
              }
            }
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
          };
          animate();
        }, []);

        const checkHit = () => {
          const g = gameRef.current;
          g.targets.forEach((t) => {
            if (t.mesh.position.distanceTo(g.crosshair.position) < 0.6) {
              soundHit.currentTime = 0;
              soundHit.play().catch(() => {});
              setScore((prev) => prev + 100);
              resetTarget(t);
            }
          });
        };

        const resetTarget = (target) => {
          const angle = Math.random() * Math.PI * 2;
          target.mesh.position.set(Math.cos(angle) * 5, Math.sin(angle) * 4, 0);
          target.velocity.set(
            (Math.random() - 0.5) * 0.1,
            (Math.random() - 0.5) * 0.1,
            0,
          );
          target.life = 200;
        };

        const startGame = async () => {
          const video = document.getElementById("video-container");
          video.style.display = "block";

          const hands = new Hands({
            locateFile: (f) =>
              `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`,
          });
          hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7,
          });
          hands.onResults((res) => {
            const found =
              res.multiHandLandmarks && res.multiHandLandmarks.length > 0;
            gameRef.current.handData = found ? res.multiHandLandmarks[0] : null;
            setHandStatus(found ? "ĐÃ NHẬN TAY" : "ĐANG TÌM TAY...");
          });

          const cam = new Camera(video, {
            onFrame: async () => {
              await hands.send({ image: video });
            },
            width: 640,
            height: 480,
          });
          await cam.start();

          for (let i = 0; i < 6; i++) {
            const mesh = new THREE.Mesh(
              new THREE.IcosahedronGeometry(0.3, 0),
              new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true }),
            );
            const target = { mesh, velocity: new THREE.Vector3(), life: 0 };
            resetTarget(target);
            gameRef.current.scene.add(mesh);
            gameRef.current.targets.push(target);
          }

          gameRef.current.isRunning = true;
          setIsRunning(true);
          setIsGameOver(false);
          setScore(0);
          setTimeLeft(gameDuration); // Sử dụng thời gian đã chọn
        };

        // Hàm thay đổi thời gian
        const adjustDuration = (amount) => {
          setGameDuration((prev) => {
            const next = prev + amount;
            if (next >= 10 && next <= 60) return next;
            return prev;
          });
        };

        useEffect(() => {
          let timer;
          if (isRunning && timeLeft > 0) {
            timer = setInterval(() => setTimeLeft((p) => p - 1), 1000);
          } else if (timeLeft === 0 && isRunning) {
            soundDone.play().catch(() => {});
            gameRef.current.isRunning = false;
            setIsRunning(false);
            setIsGameOver(true);
            document.getElementById("video-container").style.display = "none";
          }
          return () => clearInterval(timer);
        }, [isRunning, timeLeft]);

        return (
          <div id="ui-root" className="pointer-events-none">
            <div className="absolute top-10 left-10 p-4 glass-panel border-l-4 border-cyan-400">
              <div className="text-xs text-cyan-400 font-bold tracking-widest uppercase">
                SCORE
              </div>
              <div className="text-5xl font-black neon-text italic">
                {score}
              </div>
            </div>

            <div className="absolute top-10 left-1/2 -translate-x-1/2 p-4 glass-panel border-b-4 border-white text-center min-w-[150px]">
              <div className="text-xs text-white/40 font-bold uppercase tracking-widest">
                TIME
              </div>
              <div
                className={`text-5xl font-black ${timeLeft <= 5 ? "text-red-500 animate-pulse" : "text-white"}`}
              >
                {timeLeft}s
              </div>
            </div>

            {!isRunning && !isGameOver && (
              <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/80 pointer-events-auto">
                <h1 className="text-7xl font-black text-white mb-6 tracking-tighter uppercase">
                  NEON <span className="neon-text">STRIKE</span>
                </h1>

                {/* Bộ điều chỉnh thời gian */}
                <div className="flex items-center gap-6 mb-10 p-4 glass-panel rounded-xl">
                  <button
                    onClick={() => adjustDuration(-5)}
                    className="w-12 h-12 flex items-center justify-center bg-white/10 text-white text-2xl font-bold hover:bg-red-500/50 transition-colors rounded-lg"
                  >
                    -
                  </button>
                  <div className="text-center">
                    <div className="text-[10px] text-cyan-400 font-bold tracking-widest uppercase">
                      DURATION
                    </div>
                    <div className="text-3xl font-black text-white">
                      {gameDuration}s
                    </div>
                  </div>
                  <button
                    onClick={() => adjustDuration(5)}
                    className="w-12 h-12 flex items-center justify-center bg-white/10 text-white text-2xl font-bold hover:bg-cyan-500/50 transition-colors rounded-lg"
                  >
                    +
                  </button>
                </div>

                <button
                  onClick={startGame}
                  className="px-20 py-6 bg-cyan-400 text-black font-black uppercase tracking-[0.5em] shadow-[0_0_30px_#0ff] hover:scale-105 transition-transform"
                >
                  BẮT ĐẦU
                </button>
              </div>
            )}

            {isGameOver && (
              <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/95 pointer-events-auto">
                <div className="text-cyan-400 text-xs tracking-[1em] mb-4 font-bold uppercase">
                  MISSION COMPLETE
                </div>
                <div className="text-[10rem] font-black text-white leading-none mb-10 drop-shadow-[0_0_30px_#0ff]">
                  {score}
                </div>
                <button
                  onClick={() => window.location.reload()}
                  className="px-12 py-4 border-2 border-cyan-400 text-cyan-400 font-bold uppercase tracking-widest hover:bg-cyan-400 hover:text-black"
                >
                  THỬ LẠI
                </button>
              </div>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("ui-root")).render(
        <NeonApp />,
      );
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </body>
</html>
